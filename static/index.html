<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/css/layx.min.css" media="all">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <title>cliblan 示例</title>
</head>

<body>
    <div id="game"></div>
    <div class="layui-container" id="app" style="background-color: white">
        <div class="layui-row">
            <div class="layui-col-xs8">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                    <legend>广播设置</legend>
                </fieldset>

                <form class="layui-form" action="">
                    <div class="layui-form-item">
                        <label class="layui-form-label">用户ID</label>
                        <div class="layui-input-block">
                            <input type="text" placeholder="请输入" class="layui-input" readonly :value="player.uid">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">输入文字</label>
                        <div class="layui-input-block">
                            <input type="text" placeholder="请输入" class="layui-input" v-model="tinput">
                        </div>
                    </div>
                    <div class="layui-form-item layui-form-text">
                        <label class="layui-form-label">返回内容</label>
                        <div class="layui-input-block">
                            <input type="text" placeholder="返回内容" class="layui-input" readonly :value="toutput">
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button type="submit" class="layui-btn" id="send" onclick="return false;">发送</button>
                            <button type="reset" class="layui-btn layui-btn-primary" @click="clear" onclick="return false;">重置</button>
                        </div>
                    </div>
                </form>

                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                    <legend>联机选项</legend>
                </fieldset>

                <form class="layui-form" action="">
                    <div class="layui-form-item">
                        <label class="layui-form-label">对方玩家ID</label>
                        <div class="layui-input-block">
                            <input type="text" placeholder="对方玩家ID" class="layui-input" readonly :value="player.enemy">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button type="button" class="layui-btn layui-btn-normal" @click="match" :class="{ 'layui-btn-normal': player.enemy.length === 0, 'layui-btn-disabled': player.enemy.length > 0 }">开始匹配</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="js/jquery.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/layx.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/vue.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/pixi.min.js" charset="utf-8"></script>
    <script type="text/javascript">
        $(document).ready(function() {

            layx.load('init', "正在获取用户ID...");

            var app = new Vue({
                el: '#app',
                data: {
                    player: {
                        uid: "",
                        enemy: ""
                    },
                    tinput: "",
                    toutput: ""
                },
                methods: {
                    match: function() {
                        layx.load('match', "正在寻找玩家...");
                        ws.send(JSON.stringify({
                            code: "matching",
                            data: "123"
                        }));
                    },
                    clear: function() {
                        this.tinput = "";
                        this.toutput = "";
                    }
                }
            });

            var ws = new WebSocket('ws://localhost:8081');
            ws.onopen = function() {
                console.log('ws::open');
                setTimeout(function() {
                    ws.send(JSON.stringify({
                        code: "hello",
                        data: "123"
                    }));
                }, 100);
            };
            ws.onmessage = function(data) {
                data = data.data;
                console.info("data", data);
                var obj = JSON.parse(data);
                var code = obj.code;
                if (obj.code === 'broadcast') {
                    app.toutput = obj.data;
                    if (obj.data === "matching" && !app.player.enemy.length) {
                        layx.load('match', "自动：正在寻找玩家...");
                        ws.send(JSON.stringify({
                            code: "matching",
                            data: "321"
                        }));
                    }
                } else if (obj.code === 'uid') {
                    Vue.set(app.player, 'uid', obj.data);
                    console.info("uid", obj.data);
                    layx.destroy('init');
                } else if (obj.code === 'matched') {
                    Vue.set(app.player, 'enemy', obj.data);
                    layx.destroy('match');
                    begin_match();
                } else if (obj.code === 'match_disconnect') {
                    Vue.set(app.player, 'enemy', "");
                    layx.load('reload', "对方已断开连接...");
                    setTimeout(function() {
                        location.reload()
                    }, 2000);
                }
            }
            ws.onclose = function() {
                console.log('ws::close');
                layx.load('reload', "服务器已断开连接...");
                setTimeout(function() {
                    location.reload()
                }, 2000);
            }
            ws.οnerrοr = function() {
                console.error('ws::error');
            }

            $("#send").click(function() {
                if (app.tinput.length)
                    ws.send(JSON.stringify({
                        code: "broadcast",
                        data: app.tinput
                    }));
                else
                    layx.alert('错误', '请输入内容');
            });

            $(window).unload(function() {
                ws.send(JSON.stringify({
                    code: "close",
                    data: "client disconnect"
                }));
            });

            (function() {
                let type = "WebGL"
                if (!PIXI.utils.isWebGLSupported()) {
                    type = "Canvas"
                }

                PIXI.utils.sayHello(type)
            });

            var begin_match = function() {

                layx.load('gaming', "游戏初始化中……");

                let app = new PIXI.Application({
                    antialias: true
                });

                app.renderer.backgroundColor = 0xeeeeee;
                app.renderer.view.style.position = "absolute";
                app.renderer.view.style.display = "block";
                app.renderer.autoDensity = true;
                app.renderer.resize(window.innerWidth, window.innerHeight);

                $("#app").css('display', 'none');
                $(app.view).appendTo($("#game"));

                const graphics = new PIXI.Graphics();

                const style = new PIXI.TextStyle({
                    fontFamily: 'Arial',
                    fontSize: 36,
                    fontStyle: 'italic',
                    fontWeight: 'bold',
                    fill: ['#ffffff', '#00ff99'], // gradient
                    stroke: '#4a1850',
                    strokeThickness: 5,
                    dropShadow: true,
                    dropShadowColor: '#000000',
                    dropShadowBlur: 4,
                    dropShadowAngle: Math.PI / 6,
                    dropShadowDistance: 6,
                    wordWrap: true,
                    wordWrapWidth: 440,
                });

                const richText = new PIXI.Text('-- 五子棋 --', style);
                richText.x = 315;
                richText.y = 10;

                app.stage.addChild(richText);

                var r = 30;
                var edges = 30 * 19;
                var offset_w = 315;
                var offset_h = 65;

                graphics.lineStyle(1, 0x444444, 1);
                for (var i = 15; i <= edges; i += r) {
                    graphics.moveTo(offset_w + 15, offset_h + i);
                    graphics.lineTo(offset_w + edges - 15, offset_h + i);
                    graphics.moveTo(offset_w + i, offset_h + 15);
                    graphics.lineTo(offset_w + i, offset_h + edges - 15);
                }

                app.stage.addChild(graphics);

                requestAnimationFrame(animate);

                function animate() {
                    requestAnimationFrame(animate);
                    app.renderer.render(app.stage);
                }

                layx.destroy('gaming');
            }
        });
    </script>
</body>

</html>